<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>duo2</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>duo2</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>vim: filetype=python ts=2 sw=2 sts=2 et :</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>Optimizer, written as a data miner.  Break the data up into regions
of &lsquo;bad&rsquo; and &lsquo;better&rsquo;. &lsquo;Interesting&rsquo; things occur at very different
frequencies in &lsquo;bad&rsquo; and &lsquo;better&rsquo;. Find interesting bits. Combine
them. Repeat. Nearly all this processing takes log linear time.</p>
<pre><code> :-------:                 explore  = better==bad
 | Ba    | Bad &lt;----.      planning = max(better - bad)
 |    56 |          |      monitor  = max(bad - better)
 :-------:------:   |      tabu     = min(bad + better)
         | B    |   v       
         |    5 | Better
         :------:
</code></pre>
<p>(c) Tim Menzies, 2021
MIT License, https://opensource.org/licenses/MIT. The source code
does not need to be public when a distribution of the software is
made. Modifications to the software can be release under any
license. Changes made to the source code may not be documented.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="kn">from</span> <span class="nn">tricks</span> <span class="kn">import</span> <span class="n">arg</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">neg</span><span class="p">,</span> <span class="n">eg</span><span class="p">,</span> <span class="n">run</span><span class="p">,</span><span class="n">ok</span><span class="p">,</span><span class="n">o</span><span class="p">,</span><span class="n">printm</span>
<span class="kn">from</span> <span class="nn">tricks</span> <span class="kn">import</span> <span class="n">re</span><span class="p">,</span> <span class="n">sys</span><span class="p">,</span> <span class="n">math</span><span class="p">,</span> <span class="n">random</span>

<span class="n">the</span><span class="o">=</span><span class="n">args</span><span class="p">(</span><span class="s2">&quot;duo&quot;</span><span class="p">,</span><span class="vm">__doc__</span><span class="p">,</span> 
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;show version&quot;</span><span class="p">,</span> <span class="n">V</span><span class="o">=</span><span class="kc">False</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;data dir&quot;</span><span class="p">,</span> <span class="n">data</span><span class="o">=</span><span class="s2">&quot;../data/&quot;</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;misc seed&quot;</span><span class="p">,</span> <span class="n">seed</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;char for symbols&quot;</span><span class="p">,</span> <span class="n">sym</span><span class="o">=</span><span class="s2">&quot;_&quot;</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;char for numerics&quot;</span><span class="p">,</span> <span class="n">num</span><span class="o">=</span><span class="s2">&quot;:&quot;</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;char for more&quot;</span><span class="p">,</span> <span class="n">more</span><span class="o">=</span><span class="s2">&quot;&gt;&quot;</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;char for less&quot;</span><span class="p">,</span> <span class="n">less</span><span class="o">=</span><span class="s2">&quot;&lt;&quot;</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;char for skip&quot;</span><span class="p">,</span> <span class="n">skip</span><span class="o">=</span><span class="s2">&quot;?&quot;</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;char for klass&quot;</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="s2">&quot;!&quot;</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;nb kludge for rare attributes&quot;</span><span class="p">,</span> <span class="n">k</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;nb kludge for rare classes&quot;</span><span class="p">,</span> <span class="n">m</span><span class="o">=</span><span class="mi">2</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;contrast lives&quot;</span><span class="p">,</span> <span class="n">lives</span><span class="o">=</span><span class="mi">9</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;contrast population&quot;</span><span class="p">,</span> <span class="n">pop</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;contrast attempts per life&quot;</span><span class="p">,</span> <span class="n">staggers</span><span class="o">=</span><span class="mi">20</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;some epsilon x&quot;</span><span class="p">,</span> <span class="n">smallx</span><span class="o">=.</span><span class="mi">35</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;some epsilon y&quot;</span><span class="p">,</span> <span class="n">smally</span><span class="o">=.</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;some best&quot;</span><span class="p">,</span> <span class="n">best</span><span class="o">=.</span><span class="mi">80</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;some want&quot;</span><span class="p">,</span> <span class="n">chop</span><span class="o">=.</span><span class="mi">5</span><span class="p">),</span>
    <span class="n">arg</span><span class="p">(</span><span class="s2">&quot;dom samples&quot;</span><span class="p">,</span> <span class="n">samples</span><span class="o">=</span><span class="mi">64</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      <hr />
<h2>General stuff</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <h3>Predicates</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">nump</span><span class="p">(</span><span class="n">z</span><span class="p">)</span> <span class="p">:</span>   <span class="k">return</span>  <span class="n">the</span><span class="o">.</span><span class="n">less</span> <span class="ow">in</span> <span class="n">z</span> <span class="ow">or</span> <span class="n">the</span><span class="o">.</span><span class="n">more</span> <span class="ow">in</span> <span class="n">z</span> <span class="ow">or</span> <span class="n">the</span><span class="o">.</span><span class="n">num</span> <span class="ow">in</span> <span class="n">z</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">goalp</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>   <span class="k">return</span>  <span class="n">the</span><span class="o">.</span><span class="n">less</span> <span class="ow">in</span> <span class="n">z</span> <span class="ow">or</span> <span class="n">the</span><span class="o">.</span><span class="n">more</span> <span class="ow">in</span> <span class="n">z</span> <span class="ow">or</span> <span class="n">the</span><span class="o">.</span><span class="n">klass</span> <span class="ow">in</span> <span class="n">z</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">klassp</span><span class="p">(</span><span class="n">z</span><span class="p">):</span>  <span class="k">return</span>  <span class="n">the</span><span class="o">.</span><span class="n">klass</span> <span class="ow">in</span> <span class="n">z</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <h3>Structs</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">row</span><span class="p">(</span><span class="n">cells</span><span class="p">):</span> <span class="k">return</span> <span class="n">o</span><span class="p">(</span><span class="n">cells</span><span class="o">=</span><span class="n">cells</span><span class="p">,</span> <span class="n">score</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">klass</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">data</span><span class="p">():</span>     <span class="k">return</span> <span class="n">o</span><span class="p">(</span><span class="n">rows</span><span class="o">=</span><span class="p">[],</span> <span class="n">names</span><span class="o">=</span><span class="p">[],</span> <span class="n">cols</span><span class="o">=</span><span class="n">cols</span><span class="p">(),</span><span class="n">counts</span><span class="o">=</span><span class="n">tally</span><span class="p">())</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">cols</span><span class="p">():</span>     <span class="k">return</span> <span class="n">o</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="n">things</span><span class="p">(),</span> <span class="n">x</span><span class="o">=</span><span class="n">things</span><span class="p">(),</span> <span class="n">y</span><span class="o">=</span><span class="n">things</span><span class="p">(),</span> 
                         <span class="n">klass</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">w</span><span class="o">=</span><span class="p">{},</span> <span class="n">bins</span><span class="o">=</span><span class="p">{},</span><span class="n">goals</span><span class="o">=</span><span class="p">{})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">things</span><span class="p">():</span>   <span class="k">return</span> <span class="n">o</span><span class="p">(</span><span class="nb">all</span><span class="o">=</span><span class="p">{},</span><span class="n">nums</span><span class="o">=</span><span class="p">{},</span><span class="n">syms</span><span class="o">=</span><span class="p">{})</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">tally</span><span class="p">():</span>    <span class="k">return</span> <span class="n">o</span><span class="p">(</span><span class="n">f</span><span class="o">=</span><span class="p">{},</span><span class="n">h</span><span class="o">=</span><span class="p">{},</span><span class="n">n</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <h3>Misc</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Reset seed</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">r0</span><span class="p">()</span>   <span class="p">:</span> <span class="n">random</span><span class="o">.</span><span class="n">seed</span><span class="p">(</span><span class="n">the</span><span class="o">.</span><span class="n">seed</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Stats from lists (<code>sd</code> and <code>norm</code> assume sorted data)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">mu</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>     <span class="k">return</span> <span class="nb">sum</span><span class="p">(</span><span class="n">a</span><span class="p">)</span><span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">sd</span><span class="p">(</span><span class="n">a</span><span class="p">):</span>     <span class="k">return</span> <span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">9</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))]</span> <span class="o">-</span> <span class="n">a</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="o">.</span><span class="mi">1</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">a</span><span class="p">))])</span> <span class="o">/</span><span class="mf">2.56</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">norm</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">a</span><span class="p">):</span> <span class="k">return</span> <span class="nb">max</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="nb">min</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="p">(</span><span class="n">x</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">/</span><span class="p">(</span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">a</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mf">1E-32</span><span class="p">)))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Given a list of numerics, report which group holds <code>x</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">bin</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
  <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">bins</span><span class="p">):</span>
    <span class="k">if</span> <span class="n">x</span> <span class="o">&lt;=</span> <span class="n">y</span><span class="p">:</span> <span class="k">return</span> <span class="n">y</span>
  <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">inf</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Process a certain group of columns; ignore empty cells</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">cells</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span><span class="n">cols</span><span class="p">):</span>
  <span class="n">lst</span> <span class="o">=</span> <span class="n">lst</span> <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span><span class="nb">list</span><span class="p">)</span> <span class="k">else</span> <span class="n">lst</span><span class="o">.</span><span class="n">cells</span>
  <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="n">cols</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="n">val</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">val</span><span class="o">!=</span><span class="n">the</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span> <span class="k">yield</span> <span class="n">pos</span><span class="p">,</span><span class="n">val</span><span class="p">,</span><span class="n">col</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Csv reader. Kill whitespace and comments. Using columns names in
row1, control what strings get converted into floats.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">csv</span><span class="p">(</span><span class="n">file</span><span class="p">,</span> <span class="n">sep</span><span class="o">=</span><span class="s2">&quot;,&quot;</span><span class="p">,</span> <span class="n">ignore</span><span class="o">=</span><span class="sa">r</span><span class="s1">&#39;([\n\t\r ]|#.*)&#39;</span><span class="p">):</span>
  <span class="n">fs</span><span class="o">=</span><span class="p">[]</span>
  <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">file</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
    <span class="k">for</span> <span class="n">a</span> <span class="ow">in</span> <span class="n">fp</span><span class="p">:</span>
      <span class="n">a</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">sub</span><span class="p">(</span><span class="n">ignore</span><span class="p">,</span><span class="s1">&#39;&#39;</span><span class="p">,</span><span class="n">a</span><span class="p">)</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="n">sep</span><span class="p">)</span>
      <span class="k">if</span> <span class="n">fs</span><span class="p">:</span> <span class="n">a</span>  <span class="o">=</span> <span class="p">[(</span><span class="n">x</span> <span class="k">if</span> <span class="n">x</span><span class="o">==</span><span class="n">the</span><span class="o">.</span><span class="n">skip</span> <span class="k">else</span> <span class="n">f</span><span class="p">(</span><span class="n">x</span><span class="p">))</span> <span class="k">for</span> <span class="n">f</span><span class="p">,</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">fs</span><span class="p">,</span><span class="n">a</span><span class="p">)]</span>
      <span class="k">else</span><span class="p">:</span>  <span class="n">fs</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">float</span> <span class="k">if</span> <span class="n">nump</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">else</span> <span class="nb">str</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
      <span class="k">yield</span> <span class="n">a</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <hr />
<h2>Ingest</h2>
<p>Creating data tables</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">ingest</span><span class="p">(</span><span class="n">src</span><span class="p">):</span>
  <span class="n">data_</span> <span class="o">=</span><span class="n">data</span><span class="p">()</span>
  <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">src</span><span class="p">:</span>
    <span class="p">(</span><span class="n">body</span> <span class="k">if</span> <span class="n">d</span><span class="o">.</span><span class="n">names</span> <span class="k">else</span> <span class="n">head</span><span class="p">)(</span><span class="n">data_</span> <span class="p">,</span><span class="n">lst</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">footer</span><span class="p">(</span><span class="n">data_</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <h3>ingest/ head</h3>
<p>Initialize <code>data.cols</code></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">head</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span><span class="n">LST</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">head1</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">txt</span><span class="p">):</span>
    <span class="s2">&quot;Add to  (nums or syms) into (all and (x or y))&quot;</span>
    <span class="n">x</span> <span class="o">=</span> <span class="p">[]</span> <span class="k">if</span> <span class="n">nump</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="k">else</span> <span class="p">{}</span>
    <span class="k">if</span> <span class="n">klassp</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span> <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="n">x</span>
    <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="p">[</span><span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">all</span><span class="p">,</span> 
              <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">y</span> <span class="k">if</span> <span class="n">goalp</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="k">else</span> <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">x</span><span class="p">]:</span>
      <span class="n">z</span><span class="o">.</span><span class="n">all</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
      <span class="p">(</span><span class="n">z</span><span class="o">.</span><span class="n">nums</span> <span class="k">if</span> <span class="n">nump</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="k">else</span> <span class="n">z</span><span class="o">.</span><span class="n">syms</span><span class="p">)[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
    <span class="s2">&quot;Update goal and goal weights.&quot;</span>
    <span class="k">if</span> <span class="n">nump</span><span class="p">(</span><span class="n">txt</span><span class="p">)</span> <span class="ow">and</span> <span class="n">goalp</span><span class="p">(</span><span class="n">txt</span><span class="p">):</span>
       <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">goals</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">x</span>
       <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="p">(</span><span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">the</span><span class="o">.</span><span class="n">less</span> <span class="ow">in</span> <span class="n">txt</span> <span class="k">else</span> 
                          <span class="p">(</span> <span class="mi">1</span> <span class="k">if</span> <span class="n">the</span><span class="o">.</span><span class="n">more</span> <span class="ow">in</span> <span class="n">txt</span> <span class="k">else</span> <span class="mi">0</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p><code>head</code> control</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span> <span class="o">=</span>  <span class="n">cols</span><span class="p">()</span>
  <span class="n">DATA</span><span class="o">.</span><span class="n">names</span> <span class="o">=</span> <span class="n">LST</span>
  <span class="p">[</span><span class="n">head1</span><span class="p">(</span><span class="n">i</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">LST</span><span class="p">)</span> <span class="k">if</span> <span class="n">the</span><span class="o">.</span><span class="n">skip</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <h3>ingest / head / body</h3>
<p>Update the column summaries, create new rows.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">body</span><span class="p">(</span><span class="n">data</span><span class="p">,</span><span class="n">lst</span><span class="p">):</span>
  <span class="s2">&quot;Update symbolics&quot;</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">syms</span><span class="p">):</span> <span class="n">c</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="n">c</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
  <span class="s2">&quot;Update numerics&quot;</span>
  <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">c</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span> <span class="n">data</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">nums</span><span class="p">):</span> <span class="n">c</span> <span class="o">+=</span> <span class="p">[</span><span class="n">x</span><span class="p">]</span>
  <span class="s2">&quot;Make a new row&quot;</span>
  <span class="n">data</span><span class="o">.</span><span class="n">rows</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row</span><span class="p">(</span><span class="n">lst</span><span class="p">)]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <h3>ingest / head / footer</h3>
<p>All the stuff to do after reading data</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">footer</span><span class="p">(</span><span class="n">DATA</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">classify</span><span class="p">():</span> 
    <span class="s2">&quot;klass=TRUE if usually domiante others&quot;</span>
    <span class="n">ys</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">DATA</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
      <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">the</span><span class="o">.</span><span class="n">samples</span><span class="p">):</span>
        <span class="n">row</span><span class="o">.</span><span class="n">score</span> <span class="o">+=</span> <span class="n">better</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">random</span><span class="o">.</span><span class="n">choice</span><span class="p">(</span><span class="n">DATA</span><span class="o">.</span><span class="n">rows</span><span class="p">))</span>
      <span class="n">ys</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">score</span><span class="p">]</span>
    <span class="n">ys</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">ys</span><span class="p">)</span>
    <span class="n">best</span> <span class="o">=</span> <span class="n">ys</span><span class="p">[</span> <span class="nb">int</span><span class="p">(</span><span class="n">the</span><span class="o">.</span><span class="n">best</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">ys</span><span class="p">))</span> <span class="p">]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">DATA</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
      <span class="n">row</span><span class="o">.</span><span class="n">klass</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">score</span> <span class="o">&gt;</span> <span class="n">best</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">better</span><span class="p">(</span><span class="n">i</span><span class="p">,</span> <span class="n">j</span><span class="p">):</span>  
    <span class="s2">&quot;Is row `i` better than row `j`?&quot;</span>
    <span class="n">n</span> <span class="o">=</span> <span class="n">s1</span> <span class="o">=</span> <span class="n">s2</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">goals</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">col</span> <span class="ow">in</span> <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">goals</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">w</span>   <span class="o">=</span> <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">w</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
      <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">i</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span> <span class="n">j</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
      <span class="n">a</span><span class="p">,</span><span class="n">b</span> <span class="o">=</span> <span class="n">norm</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">col</span><span class="p">),</span> <span class="n">norm</span><span class="p">(</span><span class="n">b</span><span class="p">,</span><span class="n">col</span><span class="p">)</span>
      <span class="n">s1</span> <span class="o">-=</span> <span class="n">math</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">a</span> <span class="o">-</span> <span class="n">b</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
      <span class="n">s2</span> <span class="o">-=</span> <span class="n">math</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="p">(</span><span class="n">w</span> <span class="o">*</span> <span class="p">(</span><span class="n">b</span> <span class="o">-</span> <span class="n">a</span><span class="p">)</span> <span class="o">/</span> <span class="n">n</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">s1</span><span class="o">/</span><span class="n">n</span> <span class="o">&lt;</span> <span class="n">s2</span><span class="o">/</span><span class="n">n</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">discretize</span><span class="p">():</span> 
    <span class="s2">&quot;Split numerics   (uses `div` and `merge`, below.&quot;</span>
    <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">name</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">DATA</span><span class="o">.</span><span class="n">names</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">nump</span><span class="p">(</span><span class="n">name</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">goalp</span><span class="p">(</span><span class="n">name</span><span class="p">):</span>
        <span class="n">b4</span><span class="o">=</span><span class="n">div</span><span class="p">(</span><span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">nums</span><span class="p">[</span><span class="n">pos</span><span class="p">])</span>
        <span class="n">after</span><span class="o">=</span> <span class="n">merge</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">DATA</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="n">b4</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="s2">&quot;</span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">b4</span><span class="p">,</span><span class="s2">&quot; ==&gt; </span><span class="se">\n\t</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">after</span><span class="p">)</span>
        <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span> <span class="o">=</span> <span class="n">after</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">counts</span><span class="p">():</span> 
    <span class="s2">&quot;Summaries DATA via range frequency counts&quot;</span>
    <span class="n">t</span><span class="o">=</span> <span class="n">DATA</span><span class="o">.</span><span class="n">counts</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">DATA</span><span class="o">.</span><span class="n">rows</span><span class="p">:</span>
      <span class="n">t</span><span class="o">.</span><span class="n">n</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="n">klass</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">klass</span>
      <span class="n">t</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">klass</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">h</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">syms</span><span class="p">):</span>
        <span class="n">v</span><span class="o">=</span> <span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="k">for</span> <span class="n">pos</span><span class="p">,</span><span class="n">x</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">cells</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">x</span><span class="o">.</span><span class="n">nums</span><span class="p">):</span>
        <span class="n">x</span><span class="o">=</span>  <span class="nb">bin</span><span class="p">(</span><span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">bins</span><span class="p">[</span><span class="n">pos</span><span class="p">],</span><span class="n">x</span><span class="p">)</span>
        <span class="n">v</span><span class="o">=</span> <span class="p">(</span><span class="n">klass</span><span class="p">,</span> <span class="n">pos</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">t</span><span class="o">.</span><span class="n">f</span><span class="p">[</span><span class="n">v</span><span class="p">]</span> <span class="o">=</span> <span class="n">t</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="mi">0</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p><code>footer</code> control</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="p">[</span><span class="n">col</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span> <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">DATA</span><span class="o">.</span><span class="n">cols</span><span class="o">.</span><span class="n">all</span><span class="o">.</span><span class="n">nums</span><span class="o">.</span><span class="n">values</span><span class="p">()]</span>
  <span class="n">classify</span><span class="p">()</span>   <span class="c1"># count who dominates who</span>
  <span class="n">discretize</span><span class="p">()</span> <span class="c1"># must be after classify, supervised splits</span>
  <span class="n">counts</span><span class="p">()</span>     <span class="c1"># generate frequency counts</span>
  <span class="k">return</span> <span class="n">DATA</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <hr />
<h2>Discretization</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <h3>div</h3>
<p>Split sorted list of numbers into bins</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">div</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
  <span class="n">ok</span> <span class="o">=</span> <span class="n">sd</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span><span class="o">*</span><span class="n">the</span><span class="o">.</span><span class="n">smallx</span>
  <span class="n">n</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span><span class="o">**</span><span class="n">the</span><span class="o">.</span><span class="n">chop</span>
  <span class="k">while</span> <span class="n">n</span> <span class="o">&lt;</span> <span class="mi">4</span> <span class="ow">and</span> <span class="n">n</span><span class="o">&lt;</span><span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span> <span class="n">n</span><span class="o">*=</span><span class="mf">1.2</span>
  <span class="n">n</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">n</span><span class="p">)</span>
  <span class="n">out</span><span class="p">,</span> <span class="n">hi</span><span class="p">,</span> <span class="n">lo</span> <span class="o">=</span> <span class="p">[],</span> <span class="n">n</span><span class="p">,</span> <span class="mi">0</span> 
  <span class="k">while</span> <span class="n">hi</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="o">-</span> <span class="n">n</span> <span class="p">:</span>
    <span class="n">hi</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">hi</span><span class="o">-</span><span class="n">lo</span> <span class="o">&gt;</span> <span class="n">n</span>                    <span class="c1"># enough left after this split</span>
        <span class="ow">and</span> <span class="n">lst</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span> <span class="o">!=</span> <span class="n">lst</span><span class="p">[</span><span class="n">hi</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>     <span class="c1"># we can split here</span>
        <span class="ow">and</span> <span class="n">lst</span><span class="p">[</span><span class="n">hi</span><span class="p">]</span> <span class="o">-</span> <span class="n">lst</span><span class="p">[</span><span class="n">lo</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">ok</span><span class="p">):</span> <span class="c1"># split is big enough</span>
       <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="n">lst</span><span class="p">[</span><span class="n">hi</span><span class="p">]]</span>  <span class="c1"># collect the split point</span>
       <span class="n">lo</span><span class="p">,</span><span class="n">hi</span> <span class="o">=</span> <span class="n">hi</span><span class="p">,</span> <span class="n">hi</span><span class="o">+</span><span class="n">n</span>  <span class="c1"># jump to the next split</span>
  <span class="k">return</span> <span class="n">out</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <h3>merge</h3>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">merge</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span> <span class="n">rows</span><span class="p">,</span> <span class="n">bins</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">shrink</span><span class="p">(</span><span class="n">lst</span><span class="p">,</span><span class="n">ok</span><span class="p">):</span>
    <span class="s2">&quot;Combine ranges that make little change to the score.&quot;</span>
    <span class="n">j</span><span class="p">,</span><span class="n">tmp</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,[]</span>
    <span class="k">while</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">):</span>
      <span class="n">a</span><span class="p">,</span> <span class="n">y1</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="n">j</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">b</span><span class="p">,</span><span class="n">y2</span> <span class="o">=</span> <span class="n">lst</span><span class="p">[</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
        <span class="k">if</span> <span class="nb">abs</span><span class="p">(</span><span class="n">mu</span><span class="p">(</span><span class="n">y2</span><span class="p">)</span> <span class="o">-</span> <span class="n">mu</span><span class="p">(</span><span class="n">y1</span><span class="p">))</span> <span class="o">&lt;</span> <span class="n">ok</span><span class="p">:</span> <span class="c1"># too little different</span>
          <span class="n">tmp</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">b</span><span class="p">,</span><span class="n">y1</span><span class="o">+</span><span class="n">y2</span><span class="p">)]</span> <span class="c1"># extend slit to `b`</span>
          <span class="n">j</span>   <span class="o">+=</span> <span class="mi">2</span>           <span class="c1"># jump to next pair</span>
          <span class="k">continue</span>
      <span class="n">tmp</span> <span class="o">+=</span> <span class="p">[(</span><span class="n">a</span><span class="p">,</span><span class="n">y1</span><span class="p">)]</span>
      <span class="n">j</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">return</span> <span class="n">shrink</span><span class="p">(</span><span class="n">tmp</span><span class="p">,</span><span class="n">ok</span><span class="p">)</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tmp</span><span class="p">)</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="n">lst</span><span class="p">)</span> <span class="k">else</span> <span class="n">lst</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">grow</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">rows</span><span class="p">,</span><span class="n">bins</span><span class="p">):</span>
    <span class="s2">&quot;Collect the data needed for `shrink`&quot;</span>
    <span class="nb">all</span><span class="p">,</span> <span class="n">ys</span> <span class="o">=</span> <span class="p">{},[]</span>
    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
      <span class="n">x</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="n">cells</span><span class="p">[</span><span class="n">pos</span><span class="p">]</span>
      <span class="k">if</span> <span class="n">x</span> <span class="o">!=</span> <span class="n">the</span><span class="o">.</span><span class="n">skip</span><span class="p">:</span>
        <span class="n">x</span>    <span class="o">=</span> <span class="nb">bin</span><span class="p">(</span><span class="n">bins</span><span class="p">,</span> <span class="n">x</span><span class="p">)</span>
        <span class="n">one</span>  <span class="o">=</span> <span class="nb">all</span><span class="p">[</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">all</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">x</span><span class="p">,[])</span>
        <span class="n">one</span> <span class="o">+=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">score</span><span class="p">]</span>
        <span class="n">ys</span>  <span class="o">+=</span> <span class="p">[</span><span class="n">row</span><span class="o">.</span><span class="n">score</span><span class="p">]</span>
    <span class="k">return</span> <span class="nb">sorted</span><span class="p">(</span><span class="nb">all</span><span class="o">.</span><span class="n">items</span><span class="p">()),</span> <span class="n">sd</span><span class="p">(</span><span class="nb">sorted</span><span class="p">(</span><span class="n">ys</span><span class="p">))</span><span class="o">*</span><span class="n">the</span><span class="o">.</span><span class="n">smally</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p><code>merge</code> control</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">return</span> <span class="p">[</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">shrink</span><span class="p">(</span><span class="o">*</span><span class="n">grow</span><span class="p">(</span><span class="n">pos</span><span class="p">,</span><span class="n">rows</span><span class="p">,</span><span class="n">bins</span><span class="p">))]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <hr />
<h2>Contrast set learning</h2>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">contrast</span><span class="p">(</span><span class="n">rules0</span><span class="p">,</span> <span class="n">COUNTS</span><span class="p">,</span> <span class="n">HERE</span><span class="p">,</span> <span class="n">THERE</span><span class="p">):</span>
  <span class="k">return</span> <span class="n">loop</span><span class="p">([(</span><span class="n">value</span><span class="p">(</span><span class="n">r</span><span class="p">),</span><span class="n">r</span><span class="p">)</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rules0</span><span class="p">],</span> <span class="n">the</span><span class="o">.</span><span class="n">lives</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">loop</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span><span class="n">lives</span><span class="p">):</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;.&quot;</span><span class="p">,</span><span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">sum</span><span class="p">,</span> <span class="n">rules</span> <span class="o">=</span> <span class="n">prune</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">lives</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="ow">or</span> <span class="nb">len</span><span class="p">(</span><span class="n">rules</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span> <span class="k">return</span> <span class="n">rules</span>
    <span class="n">more</span><span class="o">=</span><span class="p">[]</span>
    <span class="k">for</span> <span class="n">_</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">the</span><span class="o">.</span><span class="n">staggers</span><span class="p">):</span>
      <span class="k">if</span> <span class="n">c</span> <span class="o">:=</span> <span class="n">better</span><span class="p">(</span><span class="n">pick</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span><span class="nb">sum</span><span class="p">),</span> <span class="n">pick</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span><span class="nb">sum</span><span class="p">)):</span>
        <span class="n">more</span> <span class="o">+=</span> <span class="p">[</span><span class="n">c</span><span class="p">]</span>
    <span class="k">if</span> <span class="n">more</span><span class="p">:</span>
      <span class="k">return</span> <span class="n">loop</span><span class="p">(</span><span class="n">rules</span> <span class="o">+</span> <span class="n">more</span><span class="p">,</span><span class="n">lives</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
      <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;!&quot;</span><span class="p">)</span>
      <span class="k">return</span> <span class="n">rules</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">value</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">like</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">HERE</span><span class="p">,</span>  <span class="mi">2</span><span class="p">)</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">like</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">THERE</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">b</span><span class="o">**</span><span class="mi">2</span><span class="o">/</span><span class="p">(</span><span class="n">b</span><span class="o">+</span><span class="n">r</span><span class="p">)</span> <span class="k">if</span> <span class="n">b</span><span class="o">&gt;</span><span class="n">r</span><span class="o">+</span><span class="mf">0.01</span> <span class="k">else</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">like</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span><span class="n">h</span><span class="p">,</span><span class="n">hs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">hs</span> <span class="o">=</span> <span class="n">hs</span> <span class="k">if</span> <span class="n">hs</span> <span class="k">else</span> <span class="nb">len</span><span class="p">(</span><span class="n">COUNTS</span><span class="o">.</span><span class="n">h</span><span class="p">)</span>
    <span class="n">like</span> <span class="o">=</span> <span class="n">prior</span> <span class="o">=</span> <span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">+</span> <span class="n">the</span><span class="o">.</span><span class="n">k</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">COUNTS</span><span class="o">.</span><span class="n">n</span> <span class="o">+</span> <span class="n">the</span><span class="o">.</span><span class="n">k</span> <span class="o">*</span> <span class="n">hs</span><span class="p">)</span>
    <span class="n">like</span> <span class="o">=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">like</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">col</span><span class="p">,</span><span class="n">values</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
      <span class="n">f</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">t</span><span class="o">.</span><span class="n">f</span><span class="o">.</span><span class="n">get</span><span class="p">((</span><span class="n">h</span><span class="p">,</span> <span class="n">col</span><span class="p">,</span> <span class="n">v</span><span class="p">),</span> <span class="mi">0</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">values</span><span class="p">)</span>
      <span class="n">inc</span> <span class="o">=</span> <span class="p">(</span><span class="n">f</span> <span class="o">+</span> <span class="n">the</span><span class="o">.</span><span class="n">m</span> <span class="o">*</span> <span class="n">prior</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">i</span><span class="o">.</span><span class="n">h</span><span class="p">[</span><span class="n">h</span><span class="p">]</span> <span class="o">+</span> <span class="n">the</span><span class="o">.</span><span class="n">m</span><span class="p">)</span>
      <span class="n">like</span> <span class="o">+=</span> <span class="n">math</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">inc</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">math</span><span class="o">.</span><span class="n">e</span><span class="o">**</span><span class="n">like</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">better</span><span class="p">(</span><span class="n">rule1</span><span class="p">,</span> <span class="n">rule2</span><span class="p">):</span>
    <span class="n">val1</span><span class="p">,</span> <span class="n">rule1</span> <span class="o">=</span> <span class="n">rule1</span>
    <span class="n">val2</span><span class="p">,</span> <span class="n">rule2</span> <span class="o">=</span> <span class="n">rule2</span>
    <span class="n">rule3</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">rule1</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">rule3</span><span class="p">[</span><span class="n">k</span><span class="p">]</span><span class="o">=</span><span class="n">v</span>
    <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">v</span> <span class="ow">in</span> <span class="n">rule2</span><span class="o">.</span><span class="n">items</span><span class="p">():</span> <span class="n">rule3</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">k</span><span class="p">,</span><span class="nb">set</span><span class="p">())</span> <span class="o">|</span> <span class="n">v</span>
    <span class="n">val3</span> <span class="o">=</span> <span class="n">value</span><span class="p">(</span><span class="n">rule3</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">val3</span> <span class="o">&gt;</span> <span class="n">val1</span> <span class="ow">and</span> <span class="n">val3</span> <span class="o">&gt;</span> <span class="n">val1</span><span class="p">:</span> <span class="k">return</span> <span class="p">(</span><span class="n">val3</span><span class="p">,</span><span class="n">rule3</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">prune</span><span class="p">(</span><span class="n">old</span><span class="p">):</span>
    <span class="n">tmp</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">old</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span> <span class="o">-</span><span class="mi">1</span> <span class="o">*</span> <span class="n">z</span><span class="p">[</span><span class="mi">0</span><span class="p">])[:</span><span class="n">the</span><span class="o">.</span><span class="n">pop</span><span class="p">]</span>
    <span class="n">b4</span> <span class="o">=</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">out</span> <span class="o">=</span> <span class="p">[</span><span class="n">b4</span><span class="p">]</span>
    <span class="nb">sum</span> <span class="o">=</span> <span class="n">b4</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="mf">1E-32</span>
    <span class="k">for</span> <span class="n">now</span> <span class="ow">in</span> <span class="n">tmp</span><span class="p">[</span><span class="mi">1</span><span class="p">:]:</span>
      <span class="k">if</span> <span class="n">now</span> <span class="o">!=</span> <span class="n">b4</span><span class="p">:</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="p">[</span><span class="n">now</span><span class="p">]</span>
        <span class="nb">sum</span> <span class="o">+=</span> <span class="n">now</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
      <span class="n">b4</span> <span class="o">=</span> <span class="n">now</span>
    <span class="k">return</span> <span class="nb">sum</span><span class="p">,</span><span class="n">out</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>  <span class="k">def</span> <span class="nf">pick</span><span class="p">(</span><span class="n">rules</span><span class="p">,</span> <span class="nb">sum</span><span class="p">):</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">random</span><span class="o">.</span><span class="n">random</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rules</span><span class="p">:</span>
      <span class="n">r</span> <span class="o">-=</span> <span class="n">rule</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="nb">sum</span>
      <span class="k">if</span> <span class="n">r</span> <span class="o">&lt;=</span> <span class="mi">0</span><span class="p">:</span> <span class="k">return</span> <span class="n">rule</span>
    <span class="k">return</span> <span class="n">rule</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">def</span> <span class="nf">learn</span><span class="p">(</span><span class="n">counts</span><span class="p">,</span> <span class="n">here</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
  <span class="n">out</span><span class="p">,</span> <span class="nb">all</span> <span class="o">=</span> <span class="p">{},</span> <span class="nb">set</span><span class="p">([(</span><span class="n">c</span><span class="p">,</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">c</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">h</span><span class="p">])</span>
  <span class="k">for</span> <span class="n">there</span> <span class="ow">in</span> <span class="n">counts</span><span class="o">.</span><span class="n">h</span><span class="p">:</span>
    <span class="k">if</span> <span class="n">there</span> <span class="o">!=</span> <span class="n">here</span><span class="p">:</span>
      <span class="n">out</span><span class="p">[</span><span class="n">there</span><span class="p">]</span><span class="o">=</span> <span class="n">contrast</span><span class="p">([</span><span class="nb">dict</span><span class="p">(</span><span class="n">c</span><span class="p">,</span><span class="nb">set</span><span class="p">([</span><span class="n">x</span><span class="p">]))</span> <span class="k">for</span> <span class="n">c</span><span class="p">,</span><span class="n">x</span> <span class="ow">in</span> <span class="nb">all</span><span class="p">],</span>
                           <span class="n">here</span><span class="p">,</span><span class="n">there</span><span class="p">)</span>
  <span class="k">return</span> <span class="n">out</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <hr />
<p>tests</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="nd">@eg</span>
<span class="k">def</span> <span class="nf">_csv</span><span class="p">():</span>
  <span class="nb">all</span><span class="o">=</span><span class="p">[</span><span class="n">row</span> <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">csv</span><span class="p">(</span><span class="n">the</span><span class="o">.</span><span class="n">data</span><span class="o">+</span><span class="s2">&quot;weather.csv&quot;</span><span class="p">)]</span>
  <span class="n">ok</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">all</span><span class="p">)</span><span class="o">==</span><span class="mi">15</span><span class="p">,</span><span class="s2">&quot;csv reads?&quot;</span><span class="p">)</span>
  <span class="n">ok</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="mi">5</span><span class="p">,</span><span class="s2">&quot;rows read?&quot;</span><span class="p">)</span>
  <span class="n">ok</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span><span class="o">==</span><span class="nb">float</span><span class="p">,</span> <span class="s2">&quot;floats read?&quot;</span><span class="p">)</span>
  <span class="n">ok</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="nb">all</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span><span class="o">==</span><span class="nb">str</span><span class="p">,</span> <span class="s2">&quot;strings read?&quot;</span><span class="p">)</span>

<span class="nd">@run</span>
<span class="k">def</span> <span class="nf">aa</span><span class="p">():</span>
  <span class="n">r0</span><span class="p">()</span>
  <span class="n">d</span><span class="o">=</span><span class="n">ingest</span><span class="p">(</span><span class="n">csv</span><span class="p">(</span><span class="n">the</span><span class="o">.</span><span class="n">data</span><span class="o">+</span><span class="s2">&quot;auto93.csv&quot;</span><span class="p">))</span>
  <span class="n">rows</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">rows</span><span class="p">,</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">z</span><span class="p">:</span><span class="n">z</span><span class="o">.</span><span class="n">score</span><span class="p">)</span>
  <span class="n">printm</span><span class="p">([[</span><span class="s1">&#39;score&#39;</span><span class="p">]</span><span class="o">+</span> <span class="n">d</span><span class="o">.</span><span class="n">names</span><span class="p">]</span><span class="o">+</span><span class="p">[</span>
          <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">score</span><span class="p">]</span><span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">cells</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[:</span><span class="mi">5</span><span class="p">]]</span><span class="o">+</span><span class="p">[</span>
          <span class="p">[</span><span class="n">r</span><span class="o">.</span><span class="n">score</span><span class="p">]</span><span class="o">+</span> <span class="n">r</span><span class="o">.</span><span class="n">cells</span> <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">[</span><span class="o">-</span><span class="mi">5</span><span class="p">:]])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>print(d.cols)
d = datacsv(csv(the.data+&rdquo;auto93.csv&rdquo;))
rows = sorted(d.rows,key=lambda z:z.y)
print([d.names[c] for c in d.also.y]+[&lsquo;y&rsquo;])
for r in rows[:10]: print([r.x[c] for c in d.also.y]+[r.y])
print(&ldquo;#&rdquo;)
for r in rows[-10:]: print([r.x[c] for c in d.also.y]+[r.y])
for i in range(10): print([d.rows[i].cells[x] for x in d.ys.keys()])
print(&ldquo;&rdquo;)
for i in range(10): print([d.rows[-i].cells[x] for x in d.ys.keys()])</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
